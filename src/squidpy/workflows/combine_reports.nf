nextflow.enable.dsl=2

include {
    clean;
} from '../../utils/processes/utils.nf' params(params)

workflow COMBINE_REPORTS {

    take:
        samples
        workflow_config_report ###
        qc_filter_report ### edit
        hvg_selection_report ###
        dim_reduction_report ###
        cluster_report ###

    main:
        ipynbs = qc_filter_report.map {
            it -> tuple(it[0], it[1])
        }.mix(
            samples.combine(workflow_config_report),
            hvg_selection_report.map {
                it -> tuple(it[0], it[1])
            },
            dim_reduction_report.map {
                it -> tuple(it[0], it[1])
            }
        ).groupTuple().map {
            it -> tuple(it[0], *it[1])
        }.join(
            cluster_report,
            by: 0
        )

        if(!clusteringParams.isParameterExplorationModeOn()) {
            ipynbs = ipynbs.map {
                it -> tuple(it[0], it[1..it.size()-2], null)
            }
        } else {
            ipynbs = ipynbs.map {
                it -> tuple(it[0], it[1..it.size()-2], it[it.size()-1])
            }
        }
    emit:
        out = ipynbs
}
